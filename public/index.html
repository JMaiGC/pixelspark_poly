<!DOCTYPE html>

<html>
  <head>
    <title>LLMD client</title>
  </head>

  <body>
    <div class="bar">
      <input id="apiKey" placeholder="API key..." onkeyup="fetchTasks()" />
      <input id="prompt" placeholder="Prompt..." onkeyup="promptKeyup(event)" />
      <select id="task">
        <option>Loading...</option>
      </select>
    </div>

    <textarea id="results" readonly disabled></textarea>

    <script>
      const maxTokens = 50;
      let eventSource = null;
      const taskSelect = document.getElementById("task");

      async function fetchTasks() {
        const apiKey = document.getElementById("apiKey").value;
        fetch("/task?api_key=" + encodeURIComponent(apiKey)).then(async (e) => {
          const data = await e.json();
          taskSelect.childNodes.forEach((e) => taskSelect.removeChild(e));
          for (const m of data.tasks) {
            const opt = document.createElement("OPTION");
            opt.value = m;
            opt.innerText = m;
            taskSelect.appendChild(opt);
            taskSelect.value = m;
          }
        });
      }

      fetchTasks();

      function promptKeyup(e) {
        if (e.keyCode === 13) {
          // Enter key pressed

          const prompt = document.getElementById("prompt").value;
          const apiKey = document.getElementById("apiKey").value;

          if (eventSource !== null) {
            eventSource.close();
            eventSource = null;
          }

          const task = taskSelect.value;

          const url = new URL("/task/" + task + "/live", document.location);
          url.searchParams.append("max_tokens", maxTokens);
          url.searchParams.append("prompt", prompt);
          if (apiKey.length > 0) {
            url.searchParams.append("api_key", apiKey);
          }

          eventSource = new EventSource(url);
          document.getElementById("results").value = "";

          eventSource.onmessage = function (e) {
            document.getElementById("results").value += e.data;
          };

          eventSource.onerror = function (e) {
            eventSource.close();
          };
        }
      }
    </script>

    <style type="text/css">
      * {
        box-sizing: border-box;
        font-family: Verdana;
      }

      html,
      body {
        padding: 0;
        margin: 0;
      }

      body {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      input#prompt {
        padding: 5px;
      }

      textarea#results {
        height: 200px;
        padding: 5px;
        margin: 5px;
      }

      .bar {
        display: flex;
        flex-direction: row;
        margin: 5px;
      }

      .bar > input {
        flex: 1;
      }
    </style>
  </body>
</html>
